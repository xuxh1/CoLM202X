#include <define.h>

#ifdef URBAN_MODEL
MODULE MOD_Urban_LAIReadin

  USE MOD_Precision
  IMPLICIT NONE
  SAVE

  PUBLIC :: UrbanLAI_readin

CONTAINS

 SUBROUTINE UrbanLAI_readin (year, time, dir_landdata)

! ===========================================================
! Read in urban LAI, SAI and urban tree cover data
! ===========================================================

      USE MOD_Precision
      USE MOD_Namelist
      USE MOD_SPMD_Task
      USE MOD_LandUrban
      USE MOD_Vars_Global
      USE MOD_Const_LC
      USE MOD_Vars_TimeVariables
      USE MOD_Vars_TimeInvariants
      USE MOD_Urban_Vars_TimeInvariants
      USE MOD_NetCDFVector
#ifdef SinglePoint
      USE MOD_SingleSrfdata
#endif

      IMPLICIT NONE

      INTEGER, intent(in) :: year
      INTEGER, intent(in) :: time
      CHARACTER(LEN=256), intent(in) :: dir_landdata

      CHARACTER(LEN=256) :: lndname
      CHARACTER(len=256) :: cyear, ctime
      INTEGER :: u, npatch, iyear

      ! READ in Leaf area index and stem area index
      write(ctime,'(i2.2)') time
      write(cyear,'(i4.4)') year

#ifdef SinglePoint
      iyear = findloc(SITE_LAI_year, year, dim=1)
      urb_lai(:) = SITE_LAI_monthly(time,iyear)
      urb_sai(:) = SITE_SAI_monthly(time,iyear)
#else
      lndname = trim(dir_landdata)//'/urban/'//trim(cyear)//'/LAI/urban_LAI_'//trim(ctime)//'.nc'
      call ncio_read_vector (lndname, 'TREE_LAI',  landurban, urb_lai)

      lndname = trim(dir_landdata)//'/urban/'//trim(cyear)//'/LAI/urban_SAI_'//trim(ctime)//'.nc'
      call ncio_read_vector (lndname, 'TREE_SAI',  landurban, urb_sai)
#endif
      ! loop for urban atch to assign fraction of green leaf
      IF (p_is_worker) THEN
         DO u = 1, numurban
            npatch = urban2patch(u)
            tlai(npatch) = urb_lai(u)
            tsai(npatch) = urb_sai(u)
            urb_green(u) = 1.              !TODO: usage? fraction of green leaf
            green(npatch)= 1.              !fraction of green leaf
         ENDDO
      ENDIF

 END SUBROUTINE UrbanLAI_readin

END MODULE MOD_Urban_LAIReadin
#endif
