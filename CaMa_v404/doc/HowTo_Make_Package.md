# How to generate/update CaMa-Flood package
For CaMa-Flood v4.01 on 29Mar, 2021
Dai Yamazaki
(This manual is for Yamazaki lab internal use)

## About
When we release the CaMa-Flood new version, the “model package” which contains both model codes and sample data should be created.

The “original model package” is currently managed in Yamazaki’s working directory (both rainbow & iMacPro). (e.g. /home/yamadai/work/CaMa_v401 for version 4.01)

The code is managed on GitHub, while the data (e.g. map, sample input) is managed on lab servers. 

## 1. Source code management on GitHub
The latest version of CaMa-Flood source code is managed on GitHub.
When making a new release version, create a branch, e.g. “release_v4.01”, to make sure which branch is used as the code included in the release package.

Execute **archive_src.sh** in GitHub directory, and copy the codes to “CaMa_v401/cmf_v401_src/”

## 2. Model data
The model data is managed in the lab server. We have to prepare “basic map data”, “sample input data”, “runoff climatology data for channel parameter calculation”, and some sample data for etc/ add-on.

### 2.1CaMa-Flood map
The original CaMa-Flood map is generated by FLOW upscaling method.
The original map data (e.g. glb_15min, jpn_1min) is copied from FLOW directory to cmf_v401_data/map_full/.
This can be done by m01-copy_FLOW.sh.

As the data size of the original map is very large because of the 3sec high-res data, smaller data-size maps for distribution should be created (by removing 3sec & 15sec data). Also, tar.gz archive should be prepared for data distribution.
The reduced-size map data is stored in cmf_v401_data/map/
This can be done by m02-copy_map2pkg.sh & m03-map4download.sh

### 2.2 Runoff climatology for channel param calculation
The standard runoff climatology data based on ELSE_GPCC (Kim et al., 2009) should be prepared for the CaMa-Flood package. If there is no critical change, please copy this data from previous CaMa-Flood version. This should be located to cmf_v401_data/map/data

It contains below files
~~~
ELSE_GPCC_coastmod_dayclm-1981-2010.one
ELSE_GPCC_dayclm-1981-2010.one
runoff_1981-2000_day.bin
runoff_1981-2000_day.ctl
~~~
NOTE: script for runoff pre-processing is available in CaMa-Flood/etc/

### 2.3 Sample input data
Sample input data should be located in cmf_v401_data/inp directory. If no critical bug exist, please copy it from the previous version.

It contains below files:
~~~
  test_15min_nc/
  test_1deg/
  test_jpn_1hr/
~~~

### 2.3 Sample data for etc/ add-on
Sample data for etc/ directory add-ons should be copied to package as well.
*Note: some small-size sample are included in GitHub repo.Large-size sample data should be kept in servers, and cpied when making a package.*
*Note2: when preparing sample data, please take care on data copyright and check whether re-distribution is permitted or not.*


Currently in v401, sample add-on data contains
~~~
  test_15min_nc/
  test_1deg/
  test_jpn_1hr/
~~~

## 3. Creating CaMa-Flood package
(3.1) Please copy cmf_v401_src to cmf_v401_pkg

(3.2) Edit Mkinclude
-  Go to cmf_v401_src/adm/, and edit Mkinclude

**Step (3.3) and (a.4) can be done automaticapy by make_package.sh scrpt.**

(3.2) Copy or link required data from cmf_v401_data
-  Basic map data, sample input runoff


[3.3a]test1-glb_15min.sh simulation
- Go to map/glb_15min/src_param
- Compile codes and execute s01 & s02 scripts.

[3.3b] test2-conus_06min.sh simulation
 - Go to map/conus_06min/src_regions
 - Check the regionalization domain in s01 script is OK.
 - Compile codes. Execute s01 script.
 - Confirm the conum_06min map data is generated.

[3.3c] test3-jpn_fcast.sh simulation
 - Go to map/tej_01min/src_regions
 - **Edit the regionalization domain** in s01 script (sample prepared).
 - Compile codes. Execute s01 script.
 - Go to map/tej_01min/src_params
 - **Edit input matrix info domain** in s02 script (sample prepared).
- Confirm the tej_01min map data is generated.

## 4. Execute test simulations to confirm everything is OK.
Execute sample simulations and analysis in cmf_v401_pkg.
If error is found, please modify the corresponding code on GitHub, and repeat this testing procedure.

(4.1) Compile codes
-  Go to adm/, and edit Mkinclude
-  Go to gosh/, and execute compile.sh

(4.2) Prepare and execute test simulations
 - Check whether test1, test2, test3 simulations works OK.
 - link E2O runoff input, and check test4 simulation works OK.

(4.3) Test etc/ directory add-ons
 - Downscaling of test1 simulation (downscale_flddph/)
 - Map visualization of test1, test2 simulation (result_mapping/)
 - Sample validation of test1, test2 simulations (validation/)
 - Return-period caluclation of test4 simulations (nyear-flood_depth/)
 -Test reservoir operation scheme (reservoir_operation/))

## 5. Make package when everything is OK
When everything works, please rename cmf_v400_pkg as cmv_v400_test.
Then, repeat the procedure in "3. Creating CaMa-Flood package", and then make a tar archive for distribution.



